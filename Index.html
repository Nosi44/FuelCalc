import tkinter as tk
from tkinter import ttk
from tkinter import filedialog  # ‚úÖ –¥–∏–∞–ª–æ–≥–∏ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
import json
import os


# ----------------------------
# –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
# ----------------------------
temp_coef = {
    "+8": 0.43, "+7": 0.47, "+6": 0.51, "+5": 0.555,
    "+4": 0.60, "+3": 0.645, "+2": 0.69, "+1": 0.73,
    "0": 0.77, "-1": 0.815, "-2": 0.86, "-3": 0.90,
    "-4": 0.94, "-5": 0.995, "-6": 1.03, "-7": 1.07,
    "-8": 1.11, "-9": 1.155, "-10": 1.20, "-11": 1.245,
    "-12": 1.29, "-13": 1.33, "-14": 1.37, "-15": 1.415,
    "-16": 1.46, "-17": 1.50, "-18": 1.54, "-19": 1.585,
    "-20": 1.63, "-21": 1.67, "-22": 1.71, "-23": 1.755,
    "-24": 1.80, "-25": 1.845, "-26": 1.89, "-27": 1.93,
    "-28": 1.97, "-29": 2.015, "-30": 2.06,
}

# ----------------------------
# –î—Ä–æ–≤–∞
# ----------------------------
wood_coef = {
    "–°–º–µ—à–∞–Ω—ã–µ": 0.186,
    "–ö–ª–µ–Ω": 0.262,
    "–ì—Ä–∞–±": 0.290,
    "–Ø—Å–µ–Ω—å": 0.274,
    "–î—É–±": 0.285,
    "–ë—É–∫": 0.253,
    "–ë–µ—Ä–µ–∑–∞": 0.230,
    "–í—è–∑": 0.250,
    "–°–æ—Å–Ω–∞": 0.208,
    "–û–ª—å—Ö–∞": 0.193,
    "–ï–ª—å": 0.178,
    "–û—Å–∏–∫–∞": 0.183,
    "–õ–∏–ø–∞": 0.179,
    "–ü–∏—Ö—Ç–∞": 0.175,
    "–¢–æ–ø–æ–ª—å": 0.146
}

# ----------------------------
# –•—Ä–∞–Ω–∏–º —Å—Ç—Ä–æ–∫–∏
# ----------------------------
rows = []


# ----------------------------
# –ü–µ—Ä–µ—Å—á—ë—Ç –≤—Å–µ–≥–æ
# ----------------------------
def calculate_all(*args):
    total_sum = 0

    for row in rows:
        try:
            a = temp_coef[row["temp"].get()]
            b = float(row["area"].get())
            c = float(row["days"].get())
            d = float(row["burj"].get())
            e = wood_coef[row["wood"].get()]
            f = float(row["last"].get())

            result = a * b * c / d / e / f

            row["result"].config(text=f"{result:.2f}")

            # –¥–æ–±–∞–≤–ª—è–µ–º –≤ —Å—É–º–º—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≥–∞–ª–æ—á–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞
            if row["enabled"].get() == 1:
                total_sum += result

        except:
            row["result"].config(text="...")

    label_total.config(text=f"–°—É–º–º–∞: {total_sum:.2f} —Å–∫–ª.–º.")


# ----------------------------
# –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –º–µ—Å—è—Ü–∞
# ----------------------------
def make_month_row(parent, month_name):
    frame = tk.Frame(parent)
    frame.pack(pady=5)

    # –ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—è—Ü–∞
    tk.Label(frame, text=month_name, width=10,
             anchor="w", font=("Arial", 10, "bold")).pack(side="left")

    # –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞
    combo_temp = ttk.Combobox(frame, values=list(temp_coef.keys()),
                              width=5, state="readonly")
    combo_temp.current(0)
    combo_temp.pack(side="left")

    tk.Label(frame, text=" * ").pack(side="left")

    # –∫–≤/–º
    entry_area = tk.Entry(frame, width=6)
    entry_area.insert(0, "25")
    entry_area.pack(side="left")

    tk.Label(frame, text=" * ").pack(side="left")

    # –¥–Ω–∏
    entry_days = tk.Entry(frame, width=6)
    entry_days.insert(0, "30")
    entry_days.pack(side="left")

    tk.Label(frame, text=" / ").pack(side="left")

    # –∫.–±—É—Ä–∂
    entry_burj = tk.Entry(frame, width=6)
    entry_burj.insert(0, "0.44")
    entry_burj.pack(side="left")

    tk.Label(frame, text=" / ").pack(side="left")

    # –¥–µ—Ä–µ–≤–æ
    combo_wood = ttk.Combobox(frame, values=list(wood_coef.keys()),
                              width=10, state="readonly")
    combo_wood.current(0)
    combo_wood.pack(side="left")

    tk.Label(frame, text=" / ").pack(side="left")

    # 1000
    entry_last = tk.Entry(frame, width=6)
    entry_last.insert(0, "1000")
    entry_last.pack(side="left")

    tk.Label(frame, text=" = ").pack(side="left")

    # —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    label_result = tk.Label(frame, text="0.00",
                            width=7, font=("Arial", 10, "bold"))
    label_result.pack(side="left")

    # —á–µ–∫–±–æ–∫—Å –≤–∫–ª—é—á–µ–Ω–∏—è –º–µ—Å—è—Ü–∞
    enabled_var = tk.IntVar(value=1)

    checkbox = tk.Checkbutton(
        frame,
        text="–≤ —Å—É–º–º—É",
        variable=enabled_var,
        command=calculate_all
    )
    checkbox.pack(side="left", padx=10)

    # —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç—Ä–æ–∫—É
    row = {
        "temp": combo_temp,
        "area": entry_area,
        "days": entry_days,
        "burj": entry_burj,
        "wood": combo_wood,
        "last": entry_last,
        "result": label_result,
        "enabled": enabled_var
    }
    rows.append(row)

    # –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    combo_temp.bind("<<ComboboxSelected>>", calculate_all)
    combo_wood.bind("<<ComboboxSelected>>", calculate_all)

    for entry in [entry_area, entry_days, entry_burj, entry_last]:
        entry.bind("<KeyRelease>", calculate_all)


# -----------------------------
# üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
# -----------------------------
def save_state():
    file_path = filedialog.asksaveasfilename(
        defaultextension=".json",
        filetypes=[("JSON —Ñ–∞–π–ª—ã", "*.json")],
        title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –∫–∞–∫..."
    )

    if not file_path:
        return

    data = {}

    for i, row in enumerate(rows):
        data[i] = {
            "temp": row["temp"].get(),
            "area": row["area"].get(),
            "days": row["days"].get(),
            "burj": row["burj"].get(),
            "wood": row["wood"].get(),
            "last": row["last"].get(),
            "enabled": row["enabled"].get()
        }

    with open(file_path, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=4)

    label_status.config(text="–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!")


# -----------------------------
# üìÇ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
# -----------------------------
def load_state():
    file_path = filedialog.askopenfilename(
        filetypes=[("JSON —Ñ–∞–π–ª—ã", "*.json")],
        title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É..."
    )

    if not file_path:
        return

    with open(file_path, "r", encoding="utf-8") as f:
        data = json.load(f)

    for i, row in enumerate(rows):
        if str(i) in data:
            saved = data[str(i)]

            row["temp"].set(saved["temp"])

            row["area"].delete(0, tk.END)
            row["area"].insert(0, saved["area"])

            row["days"].delete(0, tk.END)
            row["days"].insert(0, saved["days"])

            row["burj"].delete(0, tk.END)
            row["burj"].insert(0, saved["burj"])

            row["last"].delete(0, tk.END)
            row["last"].insert(0, saved["last"])

            row["wood"].set(saved["wood"])
            row["enabled"].set(saved["enabled"])

    calculate_all()
    label_status.config(text="–ó–∞–≥—Ä—É–∂–µ–Ω–æ!")


# ----------------------------
# –ì–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ
# ----------------------------
window = tk.Tk()
window.title("–†–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞ (–û–∫—Ç—è–±—Ä—å‚Äì–ú–∞—Ä—Ç)")
window.geometry("1300x450")

main = tk.Frame(window)
main.pack(pady=15)

# 6 –º–µ—Å—è—Ü–µ–≤
make_month_row(main, "–û–∫—Ç—è–±—Ä—å")
make_month_row(main, "–ù–æ—è–±—Ä—å")
make_month_row(main, "–î–µ–∫–∞–±—Ä—å")
make_month_row(main, "–Ø–Ω–≤–∞—Ä—å")
make_month_row(main, "–§–µ–≤—Ä–∞–ª—å")
make_month_row(main, "–ú–∞—Ä—Ç")

# –ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞
label_total = tk.Label(window, text="–°—É–º–º–∞: 0.00 —Å–∫–ª.–º.",
                       font=("Arial", 15, "bold"))
label_total.pack(pady=10)

# –°—Ç–∞—Ç—É—Å
label_status = tk.Label(window, text="", font=("Arial", 10))
label_status.pack()

# –ö–Ω–æ–ø–∫–∏
btn_frame = tk.Frame(window)
btn_frame.pack(pady=15)

tk.Button(btn_frame, text="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å...", command=save_state,
          width=15).pack(side="left", padx=10)

tk.Button(btn_frame, text="–ó–∞–≥—Ä—É–∑–∏—Ç—å...", command=load_state,
          width=15).pack(side="left", padx=10)

calculate_all()

window.mainloop()
